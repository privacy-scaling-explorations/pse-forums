# Roadmap and Task Plan: Modular Forum Backend

This document outlines a high-level roadmap and task plan for implementing a modular forum backend with separate authentication (Authn) and authorization (Authz) layers, group-based policies, and a pluggable verification layer using Rust, Axum, and rspc.

---

## Phase 1: Foundational Setup

### Domain Layer

- **Define Core Traits:**
  - [x] Create traits for repositories (e.g., `UserRepository`, `PostRepository`).
  - [x] Define a generic `Verifier` trait for pluggable proof mechanisms.

### Infra Layer

- **Database Connection:**
  - [x] Set up PostgreSQL connectivity using SQLx or preferred ORM.
  - [x] Create functions to initialize and manage database pools.

- **Implement Repositories:**
  - [ ] Implement the CRUD traits for `UserRepository`.
    - [x] C
    - [x] R
    - [ ] U
    - [x] D
  - [ ] Implement the RU traits for `ProfileRepository`.
    - [x] R
    - [ ] U
  - [ ] Implement the CRUD traits for `CommentRepository`.
    - [x] C
    - [x] R
    - [ ] U
    - [x] D
  - [ ] Implement the CRUD traits for `PostRepository`.
    - [x] C
    - [x] R
    - [ ] U
    - [x] D
  - [ ] Implement the CRUD traits for `GroupRepository`.
    - [ ] C
    - [ ] R
    - [ ] U
    - [ ] D

### Services Layer

- **Create Base Modules:**
  - [ ] Implement stub functions in `authn.rs` and `authz.rs`.
  - [x] Create placeholder functions in `user.rs`, `post.rs`, and `comment.rs`.

### API Layer

- **Setup Basic Routing:**
  - [x] Define feature-specific route modules under `api/src/routes/`.
  - [x] Set up a simple Axum server with a placeholder route to test connectivity.
  - [x] Integrate rspc with a basic RPC endpoint as a proof of concept.

---

## Phase 2: Authentication Implementation

### Services Layer (authn.rs)

- [x] **User Signup:**
  - Implement password hashing and user creation using `infra`.
- [ ] **User Login:**
  - Implement credential verification.
  - Issue JWT tokens on successful login.

### Infra Layer

- [x] **User Repository Enhancements:**
  - Extend repository to support user lookup by username/email.

### Middleware and API Integration

- [ ] **Authentication Middleware:**
  - Develop Axum middleware to extract and verify JWT from requests.
  - Inject authenticated user info (e.g., user ID) into request context.
- [ ] **Protect Endpoints:**
  - Apply authentication middleware to endpoints requiring a logged-in user.

---

## Phase 3: Basic Authorization & Group Policies

### Domain & Infra

- [ ] **Group Schema & Repository:**
  - Define database schema for groups, including policy attributes.
  - Implement repository functions to fetch group details and policies.

### Services Layer (authz.rs)

- [ ] **Group Policy Retrieval:**
  - Implement `get_group_policy(group_id)` to fetch policy data from the database.
- [ ] **Verification Stub:**
  - Implement a basic `verify_group_proof(group_id, proof)` that acts as a placeholder for actual proof logic.

### API Integration for Group-Based Actions

- [ ] **Define `post.create` Endpoint:**
  - Accept payload with `groupId`, `postContent`, and optional `verificationPayload`.
- [ ] **Endpoint Handler Logic:**
  - Extract parameters from the request.
  - Retrieve group policy via `authz::get_group_policy`.
  - If required by policy, call `authz::verify_group_proof`.
  - If verified/allowed, delegate to `post::create_post` in services.

---

## Phase 4: Pluggable Verification Layer

### Domain Layer

- [ ] **Refine `Verifier` Trait:**
  - Ensure the trait supports various proof types and returns structured results.

### Implement Basic Verifiers

- [ ] **JWT Verifier:**
  - Create a module implementing `Verifier` for JWTs.
- [ ] **Stub ZKP Verifier:**
  - Implement a placeholder verifier for ZKP proofs to simulate verification.

### Services Layer Integration

- [ ] **Integrate with Authz:**
  - In `authz.rs`, use the appropriate verifier based on context (e.g., group policy requires ZKP).
  - Refactor `verify_group_proof` to delegate to the pluggable verifier.

---

## Phase 5: Expand Features and Polish

### Services Endpoints

- [ ] **Additional CRUD Operations:**
  - Implement full CRUD for posts, users, and comments using respective service modules.
  - Ensure each operation follows authentication and authorization flows as needed.

### Error Handling & Logging

- [ ] **Improve Error Responses:**
  - Standardize error messages and HTTP status codes.
- [ ] **Add Logging:**
  - Integrate logging for critical operations, authentication, authorization, and errors.

### Testing

- [ ] **Unit Tests:**
  - Write tests for authn and authz functions.
  - Test repository operations against a test database.
- [ ] **Integration Tests:**
  - Simulate API calls to endpoints, checking authentication and authorization behavior.

---

## Phase 6: Refinement and Enhancement

### Advanced Verification

- [ ] **Integrate Real ZKP Library:**
  - Replace stub verifiers with actual ZKP verification logic as needed.
- [ ] **Enhance Verifier Interface:**
  - Allow for dynamic selection of verifiers based on policy requirements.

### Policy Management Refinement

- [ ] **Dynamic Policies:**
  - Expand group policies to include more conditions if necessary.
- [ ] **Administration Tools:**
  - Develop endpoints or interfaces to create/update group policies.

### Documentation

- [ ] **Code Documentation:**
  - Document core traits, service functions, and API endpoints.
- [ ] **User Guide:**
  - Provide usage examples for developers interacting with the API.

---

## Rationale and Trade-offs Recap

- **Separation of Concerns:**
  The layered approach (Domain, Infra, Services, API) keeps responsibilities clear, allowing for easier maintenance and future extension.

- **Simple Start:**
  Avoid complex policy engines and advanced middleware initially. Handle group policy logic within service methods to simplify design and preserve flexibility.

- **Middleware Usage:**
  Use middleware for broad concerns like authentication. Handle dynamic, request-specific authorization (e.g., group policies) in service logic.

- **Pluggable Verification:**
  Start with stubs and one-off proof verification without token issuance for anonymous access, ensuring simplicity and modularity. Enhance incrementally to support more complex scenarios.

- **Group-Based Policy Handling:**
  Implement flexible group policies by fetching and applying them in service logic. This approach adds per-request complexity but increases flexibility and future-proofing.

This roadmap provides a structured plan to develop the forum backend, starting simple and incrementally adding complexity as requirements evolve.
